import io
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image

def generate_medical_pdf(user, predictions, assessments, lab_searches):
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=letter, rightMargin=72, leftMargin=72, topMargin=72, bottomMargin=18)
    
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'MainTitle',
        parent=styles['Heading1'],
        fontSize=24,
        textColor=colors.HexColor("#0d6efd"),
        spaceAfter=30,
        alignment=1
    )
    
    section_style = ParagraphStyle(
        'SectionTitle',
        parent=styles['Heading2'],
        fontSize=14,
        
        textColor=colors.black,
        borderPadding=5,
        borderWidth=0,
        spaceBefore=20,
        spaceAfter=10
    )

    elements = []

    # Title
    elements.append(Paragraph("CardioAI Medical Summary Report", title_style))
    elements.append(Paragraph(f"Patient Profile: {user.first_name} {user.last_name} (@{user.username})", styles['Normal']))
    elements.append(Paragraph(f"Generated on: {predictions[0].predicted_at.strftime('%B %d, %Y') if predictions else 'N/A'}", styles['Normal']))
    elements.append(Spacer(1, 0.5 * inch))

    # 1. Heart Disease Predictions
    elements.append(Paragraph("I. Heart Disease Risk Assessments", section_style))
    data = [["Date", "Target Profile", "Result", "Probability"]]
    for p in predictions[:10]: # Top 10 latest
        data.append([
            p.predicted_at.strftime("%Y-%m-%d"),
            f"{p.patient.age}y/o {p.patient.get_sex_display()}",
            p.get_prediction_result_display(),
            f"{p.probability*100:.1f}%"
        ])
    
    t = Table(data, colWidths=[1.5*inch, 2*inch, 1.5*inch, 1*inch])
    t.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor("#f8f9fa")),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.black),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
    ]))
    elements.append(t)
    elements.append(Spacer(1, 0.3 * inch))

    # 2. Stress Tests
    if assessments:
        elements.append(Paragraph("II. Mental Health & Wellness Timeline", section_style))
        a_data = [["Date", "PHQ-2 Score", "GAD-2 Score", "Risk Level"]]
        for a in assessments[:5]:
            a_data.append([
                a.taken_at.strftime("%Y-%m-%d"),
                str(a.score_phq),
                str(a.score_gad),
                a.risk_level
            ])
        t2 = Table(a_data, colWidths=[1.5*inch, 1.5*inch, 1.5*inch, 1.5*inch])
        t2.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor("#e8f5e9")),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
        ]))
        elements.append(t2)
        elements.append(Spacer(1, 0.3 * inch))

    # 3. Medicine Inquiries
    if lab_searches:
        elements.append(Paragraph("III. Pharmaceutical Research History", section_style))
        l_data = [["Date", "Consulted Malady", "Matches Found"]]
        for l in lab_searches[:5]:
            l_data.append([
                l.searched_at.strftime("%Y-%m-%d"),
                l.query[:30],
                str(l.results_count)
            ])
        t3 = Table(l_data, colWidths=[1.5*inch, 3*inch, 1.5*inch])
        t3.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor("#e3f2fd")),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
        ]))
        elements.append(t3)

    # Disclaimer
    elements.append(Spacer(1, 0.5 * inch))
    disclaimer = """<b>IMPORTANT DISCLAIMER:</b> This document is generated by an Artificial Intelligence system (CardioAI) and is intended for clinical decision support ONLY. It does not constitute professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition."""
    elements.append(Paragraph(disclaimer, styles['Italic']))

    doc.build(elements)
    buffer.seek(0)
    return buffer


# --- Push notification helper using pywebpush ---
import json
from django.conf import settings
try:
    from pywebpush import webpush, WebPushException
except Exception:
    webpush = None
    WebPushException = Exception


def send_push(subscription_info, payload: dict):
    """Send a push notification using pywebpush. subscription_info is the dict obtained from the client subscription.
    Returns dict with 'success' True/False and 'detail'.
    """
    if webpush is None:
        return {'success': False, 'detail': 'pywebpush not installed'}

    vapid_private = getattr(settings, 'VAPID_PRIVATE_KEY', None)
    vapid_public = getattr(settings, 'VAPID_PUBLIC_KEY', None)
    vapid_email = getattr(settings, 'VAPID_EMAIL', None) or f"mailto:{getattr(settings, 'DEFAULT_FROM_EMAIL', 'no-reply@example.com')}"

    if not (vapid_private and vapid_public):
        return {'success': False, 'detail': 'VAPID keys not configured'}

    try:
        webpush(
            subscription_info=subscription_info,
            data=json.dumps(payload),
            vapid_private_key=vapid_private,
            vapid_claims={"sub": vapid_email}
        )
        return {'success': True, 'detail': 'Sent'}
    except WebPushException as ex:
        # Return useful debug
        return {'success': False, 'detail': str(ex)}
    except Exception as ex:
        return {'success': False, 'detail': str(ex)}
